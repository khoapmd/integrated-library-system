{% extends "base.html" %}

{% block title %}Circulation - Library Management System{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/scanner.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
    {% set current_page = 'circulation' %}
    {% include 'header.html' %}

    <div class="container my-5">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4 id="scannerModeIndicator">
                            <i class="fas fa-qrcode me-2"></i>Book Scanner - Check In/Out
                        </h4>
                        <small class="text-muted">Scanner for book QR codes and barcodes</small>
                    </div>
                    <div class="card-body">
                        <!-- Operation Type Selection -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Operation Type:</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="operation" id="checkout" value="checkout" checked>
                                    <label class="btn btn-outline-danger" for="checkout">
                                        <i class="fas fa-sign-out-alt me-2"></i>Check Out
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="operation" id="checkin" value="checkin">
                                    <label class="btn btn-outline-secondary" for="checkin">
                                        <i class="fas fa-sign-in-alt me-2"></i>Check In
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Workflow Guidance -->
                        <div id="workflowGuidance" class="mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-list-ol me-2"></i>Step-by-Step Guide
                                    </h6>
                                    <ol class="mb-0">
                                        <li id="step1" class="text-success">
                                            <i class="fas fa-check me-1"></i>Operation type selected: Check Out
                                        </li>
                                        <li id="step2" class="fw-bold text-primary">
                                            Second: Enter member information (required for checkout)
                                        </li>
                                        <li id="step3" class="text-muted">
                                            Third: Scan or enter book information (waiting for member)
                                        </li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Member Selection -->
                        <div id="memberSelection" class="mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user me-2"></i>Member Information
                                        <small class="text-muted ms-2">(Required for checkout)</small>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- Manual Member Input -->
                                    <div class="mb-3">
                                        <label for="memberCodeInput" class="form-label">
                                            <i class="fas fa-search me-1"></i>Enter Member Code or ID:
                                        </label>
                                        <div class="input-group">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="memberCodeInput" 
                                                   placeholder="Enter member ID, employee code, or email"
                                                   onkeypress="handleMemberCodeInput(event)">
                                            <button class="btn btn-primary" type="button" onclick="lookupMemberCode()">
                                                <i class="fas fa-search me-1"></i>Lookup
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">
                                            You can enter: Member ID, Employee Code, Employee Number, or Email Address
                                        </small>
                                    </div>
                                    
                                    <!-- Selected Member Info -->
                                    <div id="selectedMemberInfo" style="display: none;">
                                        <!-- Member info will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Book Condition Selection (for check-in) -->
                        <div id="bookConditionSelection" class="mb-3" style="display: none;">
                            <label class="form-label">Book Condition on Return:</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="bookCondition" id="conditionGood" value="good" checked>
                                        <label class="form-check-label text-success" for="conditionGood">
                                            <i class="fas fa-check-circle me-1"></i>Good Condition
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="bookCondition" id="conditionFair" value="fair">
                                        <label class="form-check-label text-warning" for="conditionFair">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Fair Condition (Minor wear)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="bookCondition" id="conditionDamaged" value="damaged">
                                        <label class="form-check-label text-danger" for="conditionDamaged">
                                            <i class="fas fa-times-circle me-1"></i>Damaged
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="bookCondition" id="conditionLost" value="lost">
                                        <label class="form-check-label text-dark" for="conditionLost">
                                            <i class="fas fa-question-circle me-1"></i>Lost/Missing
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="conditionNotesContainer" class="mt-2" style="display: none;">
                                <label for="conditionNotes" class="form-label">Condition Notes:</label>
                                <textarea class="form-control" id="conditionNotes" rows="2" placeholder="Describe the damage or issue..."></textarea>
                            </div>
                            <div id="conditionFeeContainer" class="mt-2" style="display: none;">
                                <label for="conditionFee" class="form-label">Condition Fee ($):</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="conditionFee" min="0" step="0.01" placeholder="0.00">
                                    <div class="input-group-text">
                                        <small class="text-muted">Optional</small>
                                    </div>
                                </div>
                                <small class="form-text text-muted">Leave blank for no fee, or enter custom amount</small>
                            </div>
                        </div>
                        
                        <!-- Scanner Section -->
                        <div id="scannerSection" class="mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-qrcode me-2"></i>Book Scanner
                                        <small class="text-muted ms-2">Scan QR codes and ISBN barcodes</small>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- Scanner Preview -->
                                    <div class="scanner-preview mb-3" id="unifiedScannerPreview">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-qrcode fa-3x"></i>
                                            <p class="mt-2">Book Scanner</p>
                                            <small>Scan book QR codes and ISBN barcodes</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Scanner Controls -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 mb-2 mb-md-0">
                                            <button id="bookScannerBtn" class="btn btn-secondary w-100" disabled>
                                                <i class="fas fa-qrcode me-2"></i>Scan Book QR/Barcode
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button id="manualEntryBtn" class="btn btn-secondary w-100" disabled>
                                                <i class="fas fa-keyboard me-2"></i>Manual Book Entry
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Results -->
                        <div id="circulationResults"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Current Status -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>Current Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="currentStatus">
                            <p class="text-muted">Scan a book QR code to see its status</p>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Transactions -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentTransactions">
                            <p class="text-muted">Recent transactions will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div class="modal fade" id="manualEntryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manual Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="manualBookIdentifier" class="form-label">Book Identifier:</label>
                        <input type="text" class="form-control" id="manualBookIdentifier" placeholder="Enter book UUID, ISBN, or barcode" onkeypress="if(event.key==='Enter') processManualEntry()">
                        <small class="form-text text-muted">
                            You can enter:
                            <ul class="mb-0 mt-1">
                                <li>Book UUID (e.g., 123e4567-e89b-12d3-a456-426614174000)</li>
                                <li>ISBN-10 or ISBN-13 (e.g., 1234567890, 9781234567890)</li>
                                <li>Barcode number from book's ISBN barcode</li>
                            </ul>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="processManualEntry()">Process</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <!-- Add ZXing library for QR code support in browsers without BarcodeDetector -->
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    
    <script src="{{ url_for('static', filename='js/isbn-utils.js') }}?v=20250707-104500"></script>
    <script src="{{ url_for('static', filename='js/id-pattern-utils.js') }}?v=20250707-104500"></script>
    <script src="{{ url_for('static', filename='js/scanner-module.js') }}?v=20250707-104500"></script>
    
    <script>
        let bookScanner = null;
        let members = [];
        let selectedMember = null;

        // Helper function to safely show toast notifications
        function safeToast(type, message) {
            // Check if message contains HTML tags
            const hasHtml = /<[^>]+>/.test(message);
            const options = hasHtml ? { allowHtml: true } : {};
            
            if (hasHtml) {
                console.log('üçû [CIRCULATION] Toast message contains HTML, enabling allowHtml option');
            }
            
            // Try multiple ways to access the toast system
            if (window.toast && window.toast[type.replace('show', '').toLowerCase()]) {
                // Use window.toast.success(), window.toast.error(), etc.
                const method = type.replace('show', '').toLowerCase();
                window.toast[method](message, options);
            } else if (window[type]) {
                // Use global functions like window.showSuccess(), window.showError(), etc.
                window[type](message, options);
            } else if (window.toast && window.toast.show) {
                // Fallback to generic show method
                const toastType = type.replace('show', '').toLowerCase();
                window.toast.show(message, toastType, options);
            } else {
                // Final fallback to console and alert if toast system is not available
                console.log(`Toast ${type}:`, message);
                if (type === 'showError') {
                    alert('Error: ' + message.replace(/<[^>]*>/g, '')); // Strip HTML for alert
                } else if (type === 'showWarning') {
                    alert('Warning: ' + message.replace(/<[^>]*>/g, ''));
                } else if (type === 'showSuccess') {
                    alert('Success: ' + message.replace(/<[^>]*>/g, ''));
                }
            }
        }

        // Main page initialization - removed duplicate

        // Initialize book scanner
        function initializeBookScanner() {
            bookScanner = new UniversalScanner({
                scanInterval: 1000,
                autoStop: true,
                onResults: handleBookScanResults,
                onError: handleBookScanError
            });

            bookScanner.init({
                preview: 'unifiedScannerPreview',
                toggleBtn: 'bookScannerBtn',
                statusDiv: 'circulationResults',
                resultsDiv: 'circulationResults'
            });

            console.log('üìö [CIRCULATION] Book scanner initialized');
        }

        // Book scanner result handlers
        function handleBookScanResults(results) {
            console.log('üìö [BOOK SCAN] Processing book scan results:', results);
            
            if (results && results.length > 0) {
                // Check for book QR codes
                const qrResult = results.find(r => r.type === 'QR Code');
                
                if (qrResult && qrResult.books && qrResult.books.length > 0) {
                    const book = qrResult.books[0];
                    
                    if (book.uuid) {
                        console.log('‚úÖ [BOOK SCAN] Processing book UUID:', book.uuid);
                        processCirculation(book.uuid);
                        return;
                    }
                }
                
                // Check for ISBN barcodes
                const barcodeResult = results.find(r => r.type === 'ISBN Barcode');
                if (barcodeResult && barcodeResult.books && barcodeResult.books.length > 0) {
                    const book = barcodeResult.books[0];
                    console.log('üìñ [BOOK SCAN] Processing ISBN book:', book);
                    handleISBNBook(book);
                    return;
                }
                
                // Check raw data for book UUIDs
                for (const result of results) {
                    if (result.rawData) {
                        try {
                            const jsonData = JSON.parse(result.rawData);
                            if (jsonData.uuid || jsonData.bookId || jsonData.book_id) {
                                const bookUuid = jsonData.uuid || jsonData.bookId || jsonData.book_id;
                                console.log('üìö [BOOK SCAN] Book UUID from JSON:', bookUuid);
                                processCirculation(bookUuid);
                                return;
                            }
                        } catch (e) {
                            // Check for UUID pattern in raw text
                            if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(result.rawData.trim())) {
                                console.log('üìö [BOOK SCAN] UUID pattern detected:', result.rawData);
                                processCirculation(result.rawData.trim());
                                return;
                            }
                        }
                    }
                }
                
                safeToast('showError', 'No valid book data found in scanned code');
            } else {
                safeToast('showError', 'No book QR code or barcode detected');
            }
        }

        function handleBookScanError(message) {
            console.error('üö® [BOOK SCAN] Scanner error:', message);
            safeToast('showError', `Book Scanner Error: ${message}`);
        }

        // Member code input functionality
        function handleMemberCodeInput(event) {
            if (event.key === 'Enter') {
                lookupMemberCode();
            }
        }

        async function lookupMemberCode() {
            const memberCodeInput = document.getElementById('memberCodeInput');
            const memberCode = memberCodeInput.value.trim();
            
            if (!memberCode) {
                safeToast('showWarning', 'Please enter a member code or ID');
                return;
            }
            
            console.log('üë§ [MEMBER LOOKUP] Looking up member code:', memberCode);
            
            try {
                // Try to find member by various identifiers
                const member = findMemberByCode(memberCode);
                
                if (member) {
                    selectMember(member);
                    safeToast('showSuccess', `Member found: ${member.first_name} ${member.last_name}`);
                } else {
                    // Try API lookup if not found locally
                    await lookupMemberFromAPI(memberCode);
                }
            } catch (error) {
                console.error('‚ùå [MEMBER LOOKUP] Error:', error);
                safeToast('showError', 'Error looking up member');
            }
        }

        function findMemberByCode(memberCode) {
            return members.find(m => 
                m.member_id === memberCode ||
                m.employee_code === memberCode ||
                m.employee_number === memberCode ||
                String(m.id) === memberCode ||
                m.email === memberCode
            );
        }

        async function lookupMemberFromAPI(memberCode) {
            try {
                // Try employee code lookup first
                let response = await fetch(`/api/members/employee/${memberCode}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.member) {
                        selectMember(data.member);
                        safeToast('showSuccess', `Member found: ${data.member.first_name} ${data.member.last_name}`);
                        return;
                    }
                }
                
                // Try member lookup by QR scan endpoint
                response = await fetch('/api/scan/member-qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        qr_data: memberCode
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.member) {
                        selectMember(data.member);
                        safeToast('showSuccess', `Member found: ${data.member.first_name} ${data.member.last_name}`);
                        return;
                    }
                }
                
                // Member not found
                safeToast('showWarning', `Member with code "${memberCode}" not found in system. Please check the code or add the member first.`);
                
            } catch (error) {
                console.error('‚ùå [MEMBER API] Error:', error);
                safeToast('showError', 'Error looking up member from server');
            }
        }

        function selectMember(member) {
            selectedMember = member;
            
            // Update UI to show selected member
            const selectedMemberInfo = document.getElementById('selectedMemberInfo');
            
            if (selectedMemberInfo) {
                selectedMemberInfo.innerHTML = `
                    <div class="alert alert-success">
                        <div class="row">
                            <div class="col-12">
                                <h6 class="mb-3">
                                    <i class="fas fa-user-check me-2"></i>
                                    <strong>Member Selected</strong>
                                    <span class="badge bg-success ms-2 d-none d-md-inline">
                                        <i class="fas fa-search me-1"></i>Manual Lookup
                                    </span>
                                </h6>
                                
                                <div class="member-info-list">
                                    <p class="mb-2"><strong><i class="fas fa-user me-2"></i>Name:</strong>
                                    ${member.first_name} ${member.last_name}</p>
                                    
                                    <p class="mb-2"><strong><i class="fas fa-id-card me-2"></i>Member ID:</strong>
                                    ${member.member_id}</p>
                                    
                                    ${member.employee_code ? `<p class="mb-2"><strong><i class="fas fa-id-badge me-2"></i>Employee Code:</strong> ${member.employee_code}</p>` : ''}
                                    
                                    ${member.employee_number ? `<p class="mb-2"><strong><i class="fas fa-hashtag me-2"></i>Employee Number:</strong> ${member.employee_number}</p>` : ''}
                                    
                                    ${member.department ? `<p class="mb-2"><strong><i class="fas fa-building me-2"></i>Department:</strong> ${member.department}</p>` : ''}
                                    
                                    ${member.position ? `<p class="mb-2"><strong><i class="fas fa-briefcase me-2"></i>Position:</strong> ${member.position}</p>` : ''}
                                </div>
                                
                                ${member.member_type || member.membership_type ? `
                                    <div class="mt-2">
                                        <span class="badge bg-info me-2 d-none">
                                            <i class="fas fa-tag me-1"></i>${member.member_type || member.membership_type}
                                        </span>
                                ` : ''}
                                ${member.status ? `
                                        <span class="badge ${member.status === 'active' ? 'bg-success' : member.status === 'inactive' ? 'bg-warning' : 'bg-secondary'} me-2 d-none">
                                            <i class="fas fa-circle me-1"></i>${member.status.charAt(0).toUpperCase() + member.status.slice(1)}
                                        </span>
                                ` : ''}
                                ${member.join_date || member.membership_date ? `
                                        <span class="badge bg-light text-dark me-2 d-none">
                                            <i class="fas fa-calendar me-1"></i>Joined: ${new Date(member.join_date || member.membership_date).toLocaleDateString()}
                                        </span>
                                ` : ''}
                                ${member.max_books ? `
                                        <span class="badge bg-secondary me-2 d-none">
                                            <i class="fas fa-book me-1"></i>Max Books: ${member.max_books}
                                        </span>
                                ` : ''}
                                ${member.member_type || member.membership_type || member.status || member.join_date || member.membership_date || member.max_books ? '</div>' : ''}
                                
                                <!-- Action Buttons -->
                                <div class="mt-3">
                                    <div class="d-grid gap-2 d-md-flex">
                                        <button class="btn btn-sm btn-outline-secondary w-100 w-md-auto me-md-2" onclick="clearSelectedMember()">
                                            <i class="fas fa-times me-1"></i> Clear Selection
                                        </button>
                                        <button class="btn btn-sm btn-outline-info w-100 w-md-auto me-md-2" onclick="viewMemberHistory('${member.id}')">
                                            <i class="fas fa-history me-1"></i> View History
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary w-100 w-md-auto" onclick="editMember('${member.id}')">
                                            <i class="fas fa-edit me-1"></i> Edit Member
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                selectedMemberInfo.style.display = 'block';
            }
            
            // Update workflow guidance and enable book controls
            const operation = document.querySelector('input[name="operation"]:checked').value;
            updateWorkflowGuidance(operation);
            updateBookControlsState();
            
            console.log('‚úÖ [MEMBER SELECT] Member selected:', member);
        }

        function clearSelectedMember() {
            selectedMember = null;
            document.getElementById('memberCodeInput').value = '';
            
            const selectedMemberInfo = document.getElementById('selectedMemberInfo');
            if (selectedMemberInfo) {
                selectedMemberInfo.style.display = 'none';
            }
            
            // Update workflow guidance and disable book controls if checkout mode
            const operation = document.querySelector('input[name="operation"]:checked').value;
            updateWorkflowGuidance(operation);
            updateBookControlsState();
            
            console.log('üóëÔ∏è [MEMBER CLEAR] Member selection cleared');
        }

        function clearMemberSelection() {
            clearSelectedMember();
        }

        function handleISBNBook(book) {
            console.log('üìñ [ISBN HANDLER] Processing ISBN book:', book);
            
            // Use the new ISBN processing function
            if (book.isbn) {
                processISBNForCirculation(book.isbn);
            } else {
                safeToast('showError', 'No valid ISBN found in barcode data');
            }
        }

        // Helper functions
        function clearResults() {
            const resultsDiv = document.getElementById('circulationResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '';
            }
        }

        async function addBookToLibrary(isbn) {
            try {
                const response = await fetch('/api/books/add-isbn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isbn })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    safeToast('showSuccess', `Book added to library: ${data.book.title}`);
                    clearResults();
                    
                    // Process circulation with the new book
                    if (data.book.uuid) {
                        processCirculation(data.book.uuid);
                    }
                } else {
                    safeToast('showError', `Failed to add book: ${data.error}`);
                }
            } catch (error) {
                console.error('Error adding book to library:', error);
                safeToast('showError', 'Error adding book to library');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [CIRCULATION] Circulation page initialized');
            
            // Check browser capabilities
            console.log('üìã [CIRCULATION] Browser capabilities:');
            console.log('  - BarcodeDetector:', 'BarcodeDetector' in window);
            console.log('  - ZXing library:', typeof ZXing !== 'undefined');
            console.log('  - getUserMedia:', !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));
            console.log('  - Secure context:', location.protocol === 'https:' || location.hostname === 'localhost');
            console.log('  - Toast system:', !!window.toast);
            console.log('  - Toast global functions:', {
                showSuccess: typeof window.showSuccess,
                showError: typeof window.showError,
                showWarning: typeof window.showWarning
            });
            
            // Initialize unified scanner (fallback to basic scanner)
            async function initializeUnifiedScanner() {
                try {
                    if (typeof UnifiedScannerManager !== 'undefined') {
                        unifiedScanner = new UnifiedScannerManager({
                            scanInterval: 1000,
                            debug: true,
                            onResults: handleUnifiedScanResults,
                            onError: handleUnifiedScanError,
                            onModeChange: handleModeChange
                        });

                        await unifiedScanner.init({
                            preview: 'unifiedScannerPreview',
                            bookToggleBtn: 'bookScannerBtn',
                            modeIndicator: 'scannerModeIndicator'
                        });

                        console.log('üéØ [CIRCULATION] Unified scanner initialized');
                        
                        // Set global reference
                        window.unifiedScanner = unifiedScanner;
                        console.log('üåê [CIRCULATION] Global unified scanner reference set');
                    } else {
                        console.warn('‚ö†Ô∏è [CIRCULATION] UnifiedScannerManager not available, using fallback');
                        // Fallback to basic scanner initialization
                        initializeBookScanner();
                    }
                } catch (error) {
                    console.error('‚ùå [CIRCULATION] Failed to initialize unified scanner, using fallback:', error);
                    // Fallback to basic scanner initialization
                    initializeBookScanner();
                }
            }
            
            // Initialize the scanner
            initializeUnifiedScanner().catch(error => {
                console.error('‚ùå [CIRCULATION] Failed to initialize unified scanner, using fallback:', error);
                initializeBookScanner();
            });

            // Check if toast system becomes available after a delay
            setTimeout(() => {
                console.log('üçû [CIRCULATION] Toast system check after 1 second:');
                console.log('  - window.toast:', !!window.toast);
                console.log('  - window.showSuccess:', typeof window.showSuccess);
                console.log('  - window.showError:', typeof window.showError);
                console.log('  - window.showWarning:', typeof window.showWarning);
                if (window.toast) {
                    console.log('üçû [CIRCULATION] Toast methods available:', {
                        success: typeof window.toast.success,
                        error: typeof window.toast.error,
                        warning: typeof window.toast.warning,
                        show: typeof window.toast.show
                    });
                }
            }, 1000);

            // Load members
            loadMembers();
            
            // Load recent transactions
            loadRecentTransactions();
            
            // Setup operation type change handler
            document.querySelectorAll('input[name="operation"]').forEach(radio => {
                radio.addEventListener('change', updateOperationMode);
            });
            
            // Setup book condition change handler
            document.querySelectorAll('input[name="bookCondition"]').forEach(radio => {
                radio.addEventListener('change', updateConditionNotesVisibility);
            });
            
            // Setup scanner button click handler to check workflow requirements
            document.getElementById('bookScannerBtn').addEventListener('click', function(e) {
                const operation = document.querySelector('input[name="operation"]:checked').value;
                
                if (operation === 'checkout' && !selectedMember) {
                    e.preventDefault();
                    e.stopPropagation();
                    safeToast('showWarning', 'Please select a member first before scanning for checkout.');
                    // Focus on member input
                    document.getElementById('memberCodeInput').focus();
                    return false;
                }
                
                // If requirements are met, allow the scanner to function normally
                // The actual scanner functionality is handled by the UniversalScanner
            });
            
            // Setup manual entry button click handler
            document.getElementById('manualEntryBtn').addEventListener('click', function(e) {
                const operation = document.querySelector('input[name="operation"]:checked').value;
                
                if (operation === 'checkout' && !selectedMember) {
                    e.preventDefault();
                    e.stopPropagation();
                    safeToast('showWarning', 'Please select a member first before manual book entry for checkout.');
                    // Focus on member input
                    document.getElementById('memberCodeInput').focus();
                    return false;
                }
                
                // If requirements are met, call the manual entry function
                manualEntry();
            });
            
            updateOperationMode();
        });

        // Load members for selection
        async function loadMembers() {
            try {
                const response = await fetch('/api/members');
                const data = await response.json();
                
                if (data.success) {
                    members = data.members;
                    console.log('‚úÖ [CIRCULATION] Members loaded:', members.length, 'members');
                } else {
                    console.error('Failed to load members:', data.message);
                }
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        // Note: Member dropdown functionality removed - using manual input only
        function updateMemberSelect() {
            // No longer using dropdown - members are selected via manual input only
            console.log('‚ÑπÔ∏è [CIRCULATION] Member dropdown functionality disabled');
        }

        // Update operation mode UI
        function updateOperationMode() {
            const operation = document.querySelector('input[name="operation"]:checked').value;
            const memberSelection = document.getElementById('memberSelection');
            const bookConditionSelection = document.getElementById('bookConditionSelection');
            
            // Update workflow guidance
            updateWorkflowGuidance(operation);
            
            if (operation === 'checkout') {
                memberSelection.style.display = 'block';
                bookConditionSelection.style.display = 'none';
                
                // Disable book controls until member is selected
                updateBookControlsState();
            } else {
                memberSelection.style.display = 'none';
                bookConditionSelection.style.display = 'block';
                
                // Clear member selection when switching to check-in
                clearSelectedMember();
                
                // Reset condition to good when switching to check-in
                document.getElementById('conditionGood').checked = true;
                updateConditionNotesVisibility();
                
                // For check-in, enable book controls immediately (no member required)
                enableBookControls();
            }
        }
        
        // Update workflow guidance based on operation and current state
        function updateWorkflowGuidance(operation) {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            
            // Step 1 is always completed after operation selection
            step1.className = 'text-success';
            step1.innerHTML = '<i class="fas fa-check me-1"></i>Operation type selected: ' + 
                              (operation === 'checkout' ? 'Check Out' : 'Check In');
            
            if (operation === 'checkout') {
                step2.innerHTML = 'Second: Enter member information (required for checkout)';
                step2.className = selectedMember ? 'text-success' : 'fw-bold text-primary';
                
                if (selectedMember) {
                    step2.innerHTML = '<i class="fas fa-check me-1"></i>Member selected: ' + 
                                      selectedMember.first_name + ' ' + selectedMember.last_name;
                    step3.className = 'fw-bold text-primary';
                    step3.innerHTML = 'Third: Scan or enter book information';
                } else {
                    step3.className = 'text-muted';
                    step3.innerHTML = 'Third: Scan or enter book information (waiting for member)';
                }
            } else {
                step2.className = 'text-muted';
                step2.innerHTML = 'Second: Enter member information (not required for check-in)';
                step3.className = 'fw-bold text-primary';
                step3.innerHTML = 'Third: Scan or enter book information';
            }
        }
        
        // Update book controls state based on workflow requirements
        function updateBookControlsState() {
            const operation = document.querySelector('input[name="operation"]:checked').value;
            
            if (operation === 'checkout') {
                // For checkout, require member selection
                if (selectedMember) {
                    enableBookControls();
                } else {
                    disableBookControls();
                }
            } else {
                // For check-in, no member required
                enableBookControls();
            }
        }
        
        // Enable book scanning and manual entry controls
        function enableBookControls() {
            const scanBtn = document.getElementById('bookScannerBtn');
            const manualBtn = document.getElementById('manualEntryBtn');
            
            if (scanBtn) {
                scanBtn.disabled = false;
                scanBtn.classList.remove('btn-secondary');
                scanBtn.classList.add('btn-danger');
            }
            
            if (manualBtn) {
                manualBtn.disabled = false;
                manualBtn.classList.remove('btn-secondary');
                manualBtn.classList.add('btn-outline-secondary');
            }
        }
        
        // Disable book scanning and manual entry controls
        function disableBookControls() {
            const scanBtn = document.getElementById('bookScannerBtn');
            const manualBtn = document.getElementById('manualEntryBtn');
            
            if (scanBtn) {
                scanBtn.disabled = true;
                scanBtn.classList.remove('btn-danger');
                scanBtn.classList.add('btn-secondary');
            }
            
            if (manualBtn) {
                manualBtn.disabled = true;
                manualBtn.classList.remove('btn-outline-secondary');
                manualBtn.classList.add('btn-secondary');
            }
        }

        // Update condition notes visibility based on selected condition
        function updateConditionNotesVisibility() {
            const selectedCondition = document.querySelector('input[name="bookCondition"]:checked').value;
            const notesContainer = document.getElementById('conditionNotesContainer');
            const feeContainer = document.getElementById('conditionFeeContainer');
            
            if (selectedCondition === 'damaged' || selectedCondition === 'lost') {
                notesContainer.style.display = 'block';
                feeContainer.style.display = 'block';
                document.getElementById('conditionNotes').required = true;
                
                // Set suggested default fees
                const feeInput = document.getElementById('conditionFee');
                if (selectedCondition === 'damaged' && !feeInput.value) {
                    feeInput.placeholder = '15.00 (suggested)';
                } else if (selectedCondition === 'lost' && !feeInput.value) {
                    feeInput.placeholder = '50.00 (suggested)';
                }
            } else {
                notesContainer.style.display = 'none';
                feeContainer.style.display = 'none';
                document.getElementById('conditionNotes').required = false;
                document.getElementById('conditionNotes').value = '';
                document.getElementById('conditionFee').value = '';
                document.getElementById('conditionFee').placeholder = '0.00';
            }
        }

        // Handle scan results
        async function handleScanResults(results) {
            console.log('üîç [CIRCULATION] Scan results received:', results);
            
            if (results && results.length > 0) {
                console.log('üìä [CIRCULATION] Found', results.length, 'results');
                
                // Check for book QR codes first
                const qrResult = results.find(r => r.type === 'QR Code');
                console.log('üéØ [CIRCULATION] QR result:', qrResult);
                
                if (qrResult && qrResult.books && qrResult.books.length > 0) {
                    console.log('üìö [CIRCULATION] Books found in QR:', qrResult.books);
                    const book = qrResult.books[0];
                    
                    // Check if this is a book UUID
                    if (book.uuid) {
                        console.log('‚úÖ [CIRCULATION] Processing book UUID:', book.uuid);
                        processCirculation(book.uuid);
                        return;
                    } else {
                        console.error('‚ùå [CIRCULATION] Book has no UUID:', book);
                        safeToast('showError', 'QR code does not contain valid book UUID');
                        return;
                    }
                }
                
                // Check for ISBN barcodes
                const barcodeResult = results.find(r => r.type === 'ISBN Barcode');
                console.log('üìñ [CIRCULATION] Barcode result:', barcodeResult);
                
                if (barcodeResult && barcodeResult.books && barcodeResult.books.length > 0) {
                    console.log('üìñ [CIRCULATION] Books found in barcode:', barcodeResult.books);
                    const book = barcodeResult.books[0];
                    
                    // Process ISBN barcode - look up book by ISBN
                    if (book.isbn) {
                        console.log('üìñ [CIRCULATION] Processing ISBN:', book.isbn);
                        await processISBNForCirculation(book.isbn);
                        return;
                    }
                }
                
                // Try to parse raw data for book patterns
                let recognizedData = false;
                
                for (const result of results) {
                    if (result.rawData) {
                        console.log('üîç [CIRCULATION] Analyzing raw data:', result.rawData);
                        
                        // Try to parse as JSON first
                        try {
                            const jsonData = JSON.parse(result.rawData);
                            console.log('üìÑ [CIRCULATION] Parsed JSON data:', jsonData);
                            
                            // Check if it's book data
                            if (jsonData.uuid || jsonData.bookId || jsonData.book_id) {
                                const bookUuid = jsonData.uuid || jsonData.bookId || jsonData.book_id;
                                console.log('üìö [CIRCULATION] Book UUID extracted from JSON:', bookUuid);
                                processCirculation(bookUuid);
                                recognizedData = true;
                                break;
                            }
                        } catch (e) {
                            // Not JSON, try using our comprehensive identifier processor
                            const rawData = result.rawData.trim();
                            console.log('ÔøΩ [CIRCULATION] Using processBookIdentifier for raw data:', rawData);
                            
                            // Use the comprehensive identifier processor which handles UUIDs, ISBNs, etc.
                            await processBookIdentifier(rawData);
                            recognizedData = true;
                            break;
                        }
                    }
                }
                
                if (!recognizedData) {
                    console.warn('‚ö†Ô∏è [CIRCULATION] No recognizable book data found in scan results');
                    safeToast('showError', `
                        No valid book identifier detected in scan.<br>
                        <small>Please scan a QR code with book UUID, an ISBN barcode, or enter the identifier manually.</small>
                    `);
                }
            } else {
                console.warn('‚ö†Ô∏è [CIRCULATION] No results found');
                safeToast('showError', 'No code detected');
            }
        }

        // Handle scan errors
        function handleScanError(message) {
            console.error('üö® [CIRCULATION] Scanner error:', message);
            safeToast('showError', `Scanner Error: ${message}`);
        }

        // Process circulation (check-in or check-out)
        async function processCirculation(bookUuid) {
            const operation = document.querySelector('input[name="operation"]:checked').value;
            
            // Get member ID from selectedMember (no dropdown anymore)
            let memberId = null;
            if (selectedMember) {
                memberId = selectedMember.id;
            }
            
            // Show book status first
            await showBookStatus(bookUuid);
            
            if (operation === 'checkout') {
                if (!memberId) {
                    safeToast('showError', 'Please select a member for checkout');
                    return;
                }
                await performCheckout(bookUuid, memberId);
            } else {
                await performCheckin(bookUuid);
            }
        }

        // Show book status
        async function showBookStatus(bookUuid) {
            try {
                const response = await fetch(`/api/circulation/status/${bookUuid}`);
                const data = await response.json();
                
                const statusDiv = document.getElementById('currentStatus');
                
                if (data.success) {
                    const book = data.book;
                    const activeTransactions = data.active_transactions;
                    
                    let html = `
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">${book.title}</h6>
                                <p class="card-text">
                                    <strong>Author:</strong> ${book.author}<br>
                                    <strong>ISBN:</strong> ${book.isbn}<br>
                                    <strong>Available:</strong> ${book.copies_available}/${book.copies_total}
                                </p>
                    `;
                    
                    if (activeTransactions.length > 0) {
                        html += '<h6>Currently Borrowed:</h6><ul class="list-unstyled">';
                        activeTransactions.forEach(trans => {
                            const member = trans.member;
                            const isOverdue = trans.is_overdue;
                            html += `
                                <li class="small ${isOverdue ? 'text-danger' : ''}">
                                    ${member.first_name} ${member.last_name}
                                    <br>Due: ${new Date(trans.due_date).toLocaleDateString()}
                                    ${isOverdue ? '<span class="badge bg-danger">OVERDUE</span>' : ''}
                                </li>
                            `;
                        });
                        html += '</ul>';
                    }
                    
                    html += '</div></div>';
                    statusDiv.innerHTML = html;
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error getting book status:', error);
                document.getElementById('currentStatus').innerHTML = 
                    '<div class="alert alert-danger">Error loading book status</div>';
            }
        }

        // Perform checkout
        async function performCheckout(bookUuid, memberId) {
            try {
                const response = await fetch('/api/circulation/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        book_uuid: bookUuid,
                        member_id: memberId,
                        due_days: 14
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    safeToast('showSuccess', `
                        <strong>Check-out Successful!</strong><br>
                        Book: ${data.book.title}<br>
                        Member: ${data.member.first_name} ${data.member.last_name}<br>
                        Due Date: ${new Date(data.due_date).toLocaleDateString()}
                    `);
                    
                    // Refresh book status
                    await showBookStatus(bookUuid);
                    
                    // Refresh recent transactions
                    loadRecentTransactions();
                } else {
                    safeToast('showError', data.message);
                }
            } catch (error) {
                console.error('Checkout error:', error);
                safeToast('showError', 'Error during checkout process');
            }
        }

        // Perform checkin
        async function performCheckin(bookUuid) {
            // Get book condition details
            const condition = document.querySelector('input[name="bookCondition"]:checked').value;
            const notes = document.getElementById('conditionNotes').value.trim();
            const customFee = document.getElementById('conditionFee').value;
            
            // Validate notes if condition is damaged or lost
            if ((condition === 'damaged' || condition === 'lost') && !notes) {
                safeToast('showWarning', 'Please provide notes about the book condition');
                return;
            }
            
            // Parse condition fee (allow empty for no fee)
            let conditionFee = 0;
            if (customFee && customFee.trim() !== '') {
                conditionFee = parseFloat(customFee);
                if (isNaN(conditionFee) || conditionFee < 0) {
                    safeToast('showWarning', 'Please enter a valid condition fee amount');
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/circulation/checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        book_uuid: bookUuid,
                        condition: condition,
                        condition_notes: notes,
                        condition_fee: conditionFee
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = `
                        <strong>Check-in Successful!</strong><br>
                        Book: ${data.book.title}<br>
                        Member: ${data.member.first_name} ${data.member.last_name}
                    `;
                    
                    // Add condition information to message
                    if (condition !== 'good') {
                        const conditionText = {
                            'fair': 'Fair Condition',
                            'damaged': 'Damaged',
                            'lost': 'Lost/Missing'
                        };
                        message += `<br><span class="text-warning">Condition: ${conditionText[condition]}</span>`;
                        if (notes) {
                            message += `<br><small>Notes: ${notes}</small>`;
                        }
                    }
                    
                    if (data.fine_amount > 0) {
                        message += `<br><span class="text-warning">Overdue Fine: $${data.fine_amount.toFixed(2)}</span>`;
                    }
                    
                    // Show condition fee if applicable
                    if (data.condition_fee && data.condition_fee > 0) {
                        message += `<br><span class="text-danger">Condition Fee: $${data.condition_fee.toFixed(2)}</span>`;
                    }
                    
                    safeToast('showSuccess', message);
                    
                    // Reset form
                    document.getElementById('conditionGood').checked = true;
                    document.getElementById('conditionNotes').value = '';
                    document.getElementById('conditionFee').value = '';
                    updateConditionNotesVisibility();
                    
                    // Refresh book status
                    await showBookStatus(bookUuid);
                    
                    // Refresh recent transactions
                    loadRecentTransactions();
                } else {
                    safeToast('showError', data.message);
                }
            } catch (error) {
                console.error('Checkin error:', error);
                safeToast('showError', 'Error during checkin process');
            }
        }

        // Load recent transactions
        async function loadRecentTransactions() {
            try {
                console.log('üìã [CIRCULATION] Loading recent transactions...');
                const response = await fetch('/api/circulation/recent?limit=5');
                const data = await response.json();
                
                if (data.success) {
                    console.log('üìã [CIRCULATION] Loaded', data.count, 'recent transactions');
                    updateRecentTransactionsDisplay(data.transactions);
                } else {
                    console.error('Failed to load recent transactions:', data.message);
                    document.getElementById('recentTransactions').innerHTML = 
                        '<div class="alert alert-warning">Failed to load recent transactions</div>';
                }
            } catch (error) {
                console.error('Error loading recent transactions:', error);
                document.getElementById('recentTransactions').innerHTML = 
                    '<div class="alert alert-danger">Error loading recent transactions</div>';
            }
        }

        // Update recent transactions display
        function updateRecentTransactionsDisplay(transactions) {
            const container = document.getElementById('recentTransactions');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-book-open fa-2x mb-3 opacity-50"></i>
                        <p class="mb-0">No recent transactions</p>
                        <small>Transactions will appear here after scanning</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            transactions.forEach(trans => {
                html += generateTransactionCard(trans);
            });
            
            // Add refresh button
            html += `
                <div class="text-center mt-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadRecentTransactions()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function generateTransactionCard(trans) {
            const book = trans.book;
            const member = trans.member;
            const displayDate = new Date(trans.display_date).toLocaleString();
            const timeAgo = getTimeAgo(new Date(trans.display_date));
            
            // Determine status and styling
            let statusInfo = getTransactionStatusInfo(trans);
            
            // Truncate long titles for display
            const bookTitle = book ? book.title : 'Unknown Book';
            const truncatedTitle = bookTitle.length > 30 ? bookTitle.substring(0, 30) + '...' : bookTitle;
            
            return `
                <div class="card mb-3 transaction-card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1 me-2" style="min-width: 0;">
                                <h6 class="card-title mb-1" title="${bookTitle}">
                                    <i class="fas fa-book me-2 text-muted"></i>
                                    ${truncatedTitle}
                                </h6>
                                <p class="card-text mb-1">
                                    <small class="text-muted">
                                        <i class="fas fa-user me-1"></i>
                                        ${member ? `${member.first_name} ${member.last_name}` : 'Unknown Member'}
                                    </small>
                                </p>
                            </div>
                            <span class="badge ${statusInfo.class}" title="${statusInfo.text}">${statusInfo.text}</span>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                ${timeAgo}
                            </small>
                            <small class="text-muted">${displayDate}</small>
                        </div>
                        
                        ${generateTransactionDetails(trans)}
                    </div>
                </div>
            `;
        }
        
        
        function getTransactionStatusInfo(trans) {
            if (trans.display_type === 'Check-in') {
                if (trans.return_condition && trans.return_condition !== 'good') {
                    const conditionText = {
                        'fair': 'Returned (Fair)',
                        'damaged': 'Returned (Damaged)',
                        'lost': 'Reported Lost'
                    };
                    const conditionClass = {
                        'fair': 'bg-warning',
                        'damaged': 'bg-danger',
                        'lost': 'bg-dark'
                    };
                    return {
                        text: conditionText[trans.return_condition] || 'Returned',
                        class: conditionClass[trans.return_condition] || 'bg-success'
                    };
                }
                return { text: 'Returned', class: 'bg-success' };
            } else {
                if (trans.is_overdue) {
                    return { text: 'Overdue', class: 'bg-danger' };
                } else if (trans.days_until_due !== undefined && trans.days_until_due <= 3) {
                    return { text: 'Due Soon', class: 'bg-warning' };
                }
                return { text: 'Borrowed', class: 'bg-info' };
            }
        }
        
        function generateTransactionDetails(trans) {
            let details = '';
            
            // Add fee information if applicable
            if (trans.fine_amount > 0 || trans.condition_fee > 0) {
                details += '<div class="mt-2 pt-2 border-top">';
                if (trans.fine_amount > 0) {
                    details += `<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Fine: $${trans.fine_amount.toFixed(2)}</small>`;
                }
                if (trans.condition_fee > 0) {
                    details += `<small class="text-danger ms-3"><i class="fas fa-dollar-sign me-1"></i>Condition Fee: $${trans.condition_fee.toFixed(2)}</small>`;
                }
                details += '</div>';
            }
            
            // Add due date for active loans
            if (trans.status === 'active' && trans.due_date) {
                const dueDate = new Date(trans.due_date).toLocaleDateString();
                details += `
                    <div class="mt-2 pt-2 border-top">
                        <small class="text-info">
                            <i class="fas fa-calendar-alt me-1"></i>
                            Due: ${dueDate}
                        </small>
                    </div>
                `;
            }
            
            return details;
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }
        // Manual entry
        function manualEntry() {
            // Check workflow requirements before opening modal
            const operation = document.querySelector('input[name="operation"]:checked').value;
            
            if (operation === 'checkout' && !selectedMember) {
                safeToast('showWarning', 'Please select a member first before entering book information for checkout.');
                // Focus on member input
                document.getElementById('memberCodeInput').focus();
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('manualEntryModal'));
            modal.show();
        }

        // Process manual entry
        async function processManualEntry() {
            const bookIdentifier = document.getElementById('manualBookIdentifier').value.trim();
            
            if (!bookIdentifier) {
                safeToast('showWarning', 'Please enter a book identifier (UUID, ISBN, or barcode)');
                return;
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('manualEntryModal'));
            modal.hide();
            
            // Determine what type of identifier this is and process accordingly
            await processBookIdentifier(bookIdentifier);
        }
        
        // Process book identifier (UUID, ISBN, or barcode)
        async function processBookIdentifier(identifier) {
            console.log('üîç [IDENTIFIER] Processing book identifier:', identifier);
            
            // Try to determine what type of identifier this is
            const trimmedId = identifier.trim();
            
            // Check if it's a UUID pattern
            if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(trimmedId)) {
                console.log('üìö [IDENTIFIER] Recognized as UUID, processing circulation');
                await processCirculation(trimmedId);
                return;
            }
            
            // Check if it's an ISBN (using our ISBN utilities)
            if (typeof ISBNUtils !== 'undefined') {
                const extractedIsbn = ISBNUtils.extractIsbn(trimmedId);
                if (extractedIsbn) {
                    console.log('üìñ [IDENTIFIER] Recognized as ISBN:', extractedIsbn);
                    await processISBNForCirculation(extractedIsbn);
                    return;
                }
            }
            
            // Try simple ISBN pattern recognition as fallback
            const cleanedId = trimmedId.replace(/[-\s]/g, '');
            if (/^(978|979)?[0-9]{10,13}$/i.test(cleanedId)) {
                console.log('üìñ [IDENTIFIER] Looks like ISBN, attempting processing:', cleanedId);
                await processISBNForCirculation(cleanedId);
                return;
            }
            
            // If nothing else works, try as UUID anyway (in case it's a shortened UUID)
            if (/^[0-9a-f-]+$/i.test(trimmedId)) {
                console.log('üé≤ [IDENTIFIER] Trying as UUID anyway:', trimmedId);
                await processCirculation(trimmedId);
                return;
            }
            
            // Could not recognize the identifier
            safeToast('showError', `
                Could not recognize identifier format: "${trimmedId}"<br>
                <small>Please enter a valid Book UUID or ISBN</small>
            `);
        }
        
        // Process ISBN for circulation (lookup book by ISBN)
        async function processISBNForCirculation(isbn) {
            console.log('üìñ [ISBN] Processing ISBN for circulation:', isbn);
            
            try {
                // First try to find the book by ISBN in our library
                const response = await fetch(`/api/books/isbn/${isbn}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.book && data.book.uuid) {
                        console.log('‚úÖ [ISBN] Found book in library:', data.book.title);
                        safeToast('showInfo', `Found book: ${data.book.title}`);
                        
                        // Process circulation with the found book's UUID
                        await processCirculation(data.book.uuid);
                        return;
                    }
                }
                
                // If not found in our library, try to show book info and offer to add it
                console.log('üìñ [ISBN] Book not found in library, attempting to fetch book info...');
                await handleISBNNotInLibrary(isbn);
                
            } catch (error) {
                console.error('‚ùå [ISBN] Error processing ISBN:', error);
                safeToast('showError', `Error looking up ISBN: ${error.message}`);
            }
        }
        
        // Handle ISBN when book is not in library
        async function handleISBNNotInLibrary(isbn) {
            console.log('üìñ [ISBN] Handling ISBN not in library:', isbn);
            
            try {
                // Try to get book information from external sources
                const response = await fetch('/api/books/isbn-lookup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isbn: isbn })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.book) {
                        // Show book info and offer to add it
                        showISBNBookNotFoundDialog(data.book, isbn);
                        return;
                    }
                }
                
                // Fallback: show simple not found message
                safeToast('showWarning', `
                    Book with ISBN ${isbn} not found in library.<br>
                    <small>The book may need to be added to the library first before circulation.</small>
                `);
                
            } catch (error) {
                console.error('‚ùå [ISBN] Error looking up book info:', error);
                safeToast('showError', `
                    Book with ISBN ${isbn} not found in library.<br>
                    <small>Unable to retrieve book information. The book may need to be added manually.</small>
                `);
            }
        }
        
        // Show dialog for ISBN book not found in library
        function showISBNBookNotFoundDialog(bookInfo, isbn) {
            const resultsDiv = document.getElementById('circulationResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-book me-2"></i>ISBN Book Found (Not in Library)</h6>
                        <p><strong>Title:</strong> ${bookInfo.title || 'Unknown'}</p>
                        <p><strong>Author:</strong> ${bookInfo.author || 'Unknown'}</p>
                        <p><strong>ISBN:</strong> ${isbn}</p>
                        <div class="mt-3">
                            <button class="btn btn-success me-2" onclick="addBookToLibrary('${isbn}')">
                                <i class="fas fa-plus me-1"></i>Add to Library & Process
                            </button>
                            <button class="btn btn-secondary" onclick="clearResults()">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            This book is not currently in the library. You can add it and then proceed with circulation.
                        </small>
                    </div>
                `;
            }
        }
        
        // Missing unified scanner handler functions
        function handleUnifiedScanResults(results) {
            console.log('üéØ [UNIFIED SCAN] Results received:', results);
            // For now, delegate to the main scan handler
            handleScanResults(results);
        }
        
        function handleUnifiedScanError(error) {
            console.error('üö® [UNIFIED SCAN] Error:', error);
            handleScanError(error);
        }
        
        function handleModeChange(mode) {
            console.log('üîÑ [UNIFIED SCAN] Mode changed to:', mode);
            const indicator = document.getElementById('scannerModeIndicator');
            if (indicator) {
                indicator.innerHTML = '<i class="fas fa-qrcode me-2"></i>Book Scanner - Check In/Out';
            }
        }
        
        // Manual entry function
        function manualEntry() {
            const modal = new bootstrap.Modal(document.getElementById('manualEntryModal'));
            modal.show();
        }
        
        // Member action functions
        function viewMemberHistory(memberId) {
            console.log('üë§ [MEMBER] Viewing history for member ID:', memberId);
            
            // Find the member name for better user experience
            const member = members.find(m => m.id == memberId);
            const memberName = member ? `${member.first_name} ${member.last_name}` : `Member #${memberId}`;
            
            console.log('üë§ [MEMBER] Found member:', memberName);
            
            // Show the member history modal
            showMemberHistoryModal(memberId, memberName);
        }
        
        function editMember(memberId) {
            console.log('üë§ [MEMBER] Editing member ID:', memberId);
            
            // You can implement this to open edit modal or navigate to edit page
            safeToast('showInfo', 'Opening member editor...');
            
            // Example: Navigate to edit page
            // window.location.href = `/members/${memberId}/edit`;
            
            // Or open edit modal
            showEditMemberModal(memberId);
        }
        
        function showMemberHistoryModal(memberId, memberName = '') {
            // Create and show a modal with member's circulation history
            const modalHtml = `
                <div class="modal fade" id="memberHistoryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-history me-2"></i>Circulation History
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="memberHistoryContent">
                                    <div class="text-center">
                                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                                        <p class="mt-2">Loading member history...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('memberHistoryModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('memberHistoryModal'));
            modal.show();
            
            // Load member history data
            loadMemberHistoryData(memberId);
        }
        
        function showEditMemberModal(memberId) {
            // For now, just show a placeholder
            safeToast('showInfo', `Edit functionality for member ${memberId} would be implemented here.`);
        }
        
        async function loadMemberHistoryData(memberId) {
            const content = document.getElementById('memberHistoryContent');
            
            try {
                // Try to get member's circulation history via different endpoints
                let response;
                let data;
                
                // First try: dedicated member history endpoint
                try {
                    response = await fetch(`/api/members/${memberId}/history`);
                    if (response.ok) {
                        data = await response.json();
                    }
                } catch (e) {
                    console.log('Member history endpoint not available, trying alternatives...');
                }
                
                // Second try: circulation transactions filtered by member
                if (!data || !response.ok) {
                    try {
                        response = await fetch(`/api/circulation/member/${memberId}/transactions`);
                        if (response.ok) {
                            data = await response.json();
                        }
                    } catch (e) {
                        console.log('Member transactions endpoint not available...');
                    }
                }
                
                // Third try: get recent transactions and filter by member on frontend
                if (!data || !response.ok) {
                    try {
                        response = await fetch('/api/circulation/recent?limit=50');
                        if (response.ok) {
                            const allData = await response.json();
                            if (allData.success && allData.transactions) {
                                // Filter transactions for this member
                                const memberTransactions = allData.transactions.filter(t => 
                                    t.member && (t.member.id == memberId || String(t.member.id) === String(memberId))
                                );
                                data = {
                                    success: true,
                                    history: memberTransactions.map(t => ({
                                        date: t.display_date || t.checkout_date || t.checkin_date,
                                        action: t.display_type === 'Check-in' ? 'checkin' : 'checkout',
                                        book_title: t.book ? t.book.title : 'Unknown Book',
                                        status: t.status || (t.return_date ? 'returned' : 'active'),
                                        due_date: t.due_date,
                                        return_condition: t.return_condition,
                                        fine_amount: t.fine_amount,
                                        condition_fee: t.condition_fee
                                    }))
                                };
                            }
                        }
                    } catch (e) {
                        console.log('Recent transactions endpoint also failed...');
                    }
                }
                
                // Display results
                if (data && data.success && data.history && data.history.length > 0) {
                    content.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Action</th>
                                        <th>Book</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.history.map(item => `
                                        <tr>
                                            <td>${new Date(item.date).toLocaleDateString()}</td>
                                            <td>
                                                <span class="badge ${item.action === 'checkout' ? 'bg-primary' : 'bg-success'}">
                                                    <i class="fas fa-${item.action === 'checkout' ? 'sign-out-alt' : 'sign-in-alt'} me-1"></i>
                                                    ${item.action === 'checkout' ? 'Check Out' : 'Check In'}
                                                </span>
                                            </td>
                                            <td>${item.book_title || 'Unknown Book'}</td>
                                            <td>
                                                <span class="badge ${item.status === 'active' ? 'bg-warning' : 'bg-secondary'}">
                                                    ${item.status || '-'}
                                                </span>
                                            </td>
                                            <td>
                                                ${item.due_date ? `<small>Due: ${new Date(item.due_date).toLocaleDateString()}</small><br>` : ''}
                                                ${item.return_condition && item.return_condition !== 'good' ? `<small class="text-warning">Condition: ${item.return_condition}</small><br>` : ''}
                                                ${item.fine_amount > 0 ? `<small class="text-danger">Fine: $${item.fine_amount.toFixed(2)}</small><br>` : ''}
                                                ${item.condition_fee > 0 ? `<small class="text-danger">Fee: $${item.condition_fee.toFixed(2)}</small>` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-inbox fa-3x"></i>
                            <p class="mt-2">No circulation history found for this member.</p>
                            <small class="text-muted">This could mean the member hasn't borrowed any books yet, or the history data is not available.</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading member history:', error);
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading member history. The member history service may not be available.
                        <br><small class="mt-1 d-block">Error: ${error.message}</small>
                    </div>
                `;
            }
        }
    </script>
{% endblock %}
